<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css"
    type="text/css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="./openlayers.css">
  <title>OpenLayers Exercises</title>
</head>

<body>
  <div id="map" class="map"></div>
  <div class="card">
    <div class="card-header">
      編輯
    </div>
    <div class="card-body">
      <div class="pb-3">
        <h5 class="card-title">繪製類型</h5>
        <div>
          <button id="lineBtn" type="button" class="typeBtn btn btn-outline-light"
            onclick="ChangeFeatureOfDrawing('LineString')">
            <img
              src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE5LjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB2aWV3Qm94PSIwIDAgNTEyIDUxMiIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgNTEyIDUxMjsiIHhtbDpzcGFjZT0icHJlc2VydmUiPg0KPHBhdGggc3R5bGU9ImZpbGw6IzYwN0Q4QjsiIGQ9Ik01My4zMzMsNDY5LjMzM2MtNS44OTEsMC4wMTEtMTAuNjc1LTQuNzU3LTEwLjY4Ni0xMC42NDhjLTAuMDA1LTIuODQsMS4xMjMtNS41NjUsMy4xMzQtNy41NzENCglMNDUxLjExNSw0NS43ODFjNC4wOTMtNC4yMzcsMTAuODQ1LTQuMzU0LDE1LjA4My0wLjI2MnM0LjM1NCwxMC44NDUsMC4yNjIsMTUuMDgzYy0wLjA4NiwwLjA4OS0wLjE3MywwLjE3Ni0wLjI2MiwwLjI2Mg0KCUw2MC44NjQsNDY2LjE5N0M1OC44NjgsNDY4LjE5OSw1Ni4xNiw0NjkuMzI3LDUzLjMzMyw0NjkuMzMzeiIvPg0KPGc+DQoJPHBhdGggc3R5bGU9ImZpbGw6IzQ1NUE2NDsiIGQ9Ik0xMC42NjcsNDQ4aDQyLjY2N0M1OS4yMjQsNDQ4LDY0LDQ1Mi43NzYsNjQsNDU4LjY2N3Y0Mi42NjdDNjQsNTA3LjIyNCw1OS4yMjQsNTEyLDUzLjMzMyw1MTINCgkJSDEwLjY2N0M0Ljc3Niw1MTIsMCw1MDcuMjI0LDAsNTAxLjMzM3YtNDIuNjY3QzAsNDUyLjc3Niw0Ljc3Niw0NDgsMTAuNjY3LDQ0OHoiLz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojNDU1QTY0OyIgZD0iTTQ1OC42NjcsMGg0Mi42NjdDNTA3LjIyNCwwLDUxMiw0Ljc3Niw1MTIsMTAuNjY3djQyLjY2N0M1MTIsNTkuMjI0LDUwNy4yMjQsNjQsNTAxLjMzMyw2NGgtNDIuNjY3DQoJCUM0NTIuNzc2LDY0LDQ0OCw1OS4yMjQsNDQ4LDUzLjMzM1YxMC42NjdDNDQ4LDQuNzc2LDQ1Mi43NzYsMCw0NTguNjY3LDB6Ii8+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8L3N2Zz4NCg==" />
          </button>
          <button id="faceBtn" type="button" class="typeBtn btn btn-outline-light"
            onclick="ChangeFeatureOfDrawing('Polygon')">
            <img
              src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE5LjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB2aWV3Qm94PSIwIDAgNTEyIDUxMiIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgNTEyIDUxMjsiIHhtbDpzcGFjZT0icHJlc2VydmUiPg0KPGc+DQoJPHBhdGggc3R5bGU9ImZpbGw6IzYwN0Q4QjsiIGQ9Ik0zMiw0NjkuMzMzYy01Ljg5MSwwLTEwLjY2Ny00Ljc3Ni0xMC42NjctMTAuNjY3VjUzLjMzM2MwLTUuODkxLDQuNzc2LTEwLjY2NywxMC42NjctMTAuNjY3DQoJCXMxMC42NjcsNC43NzYsMTAuNjY3LDEwLjY2N3Y0MDUuMzMzQzQyLjY2Nyw0NjQuNTU4LDM3Ljg5MSw0NjkuMzMzLDMyLDQ2OS4zMzN6Ii8+DQoJPHBhdGggc3R5bGU9ImZpbGw6IzYwN0Q4QjsiIGQ9Ik00NTguNjY3LDQyLjY2N0g1My4zMzNjLTUuODkxLDAtMTAuNjY3LTQuNzc2LTEwLjY2Ny0xMC42NjdzNC43NzYtMTAuNjY3LDEwLjY2Ny0xMC42NjdoNDA1LjMzMw0KCQljNS44OTEsMCwxMC42NjcsNC43NzYsMTAuNjY3LDEwLjY2N1M0NjQuNTU4LDQyLjY2Nyw0NTguNjY3LDQyLjY2N3oiLz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojNjA3RDhCOyIgZD0iTTQ4MCw0NjkuMzMzYy01Ljg5MSwwLTEwLjY2Ny00Ljc3Ni0xMC42NjctMTAuNjY3VjUzLjMzM2MwLTUuODkxLDQuNzc2LTEwLjY2NywxMC42NjctMTAuNjY3DQoJCWM1Ljg5MSwwLDEwLjY2Nyw0Ljc3NiwxMC42NjcsMTAuNjY3djQwNS4zMzNDNDkwLjY2Nyw0NjQuNTU4LDQ4NS44OTEsNDY5LjMzMyw0ODAsNDY5LjMzM3oiLz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojNjA3RDhCOyIgZD0iTTQ1OC42NjcsNDkwLjY2N0g1My4zMzNjLTUuODkxLDAtMTAuNjY3LTQuNzc2LTEwLjY2Ny0xMC42NjdjMC01Ljg5MSw0Ljc3Ni0xMC42NjcsMTAuNjY3LTEwLjY2Nw0KCQloNDA1LjMzM2M1Ljg5MSwwLDEwLjY2Nyw0Ljc3NiwxMC42NjcsMTAuNjY3QzQ2OS4zMzMsNDg1Ljg5MSw0NjQuNTU4LDQ5MC42NjcsNDU4LjY2Nyw0OTAuNjY3eiIvPg0KPC9nPg0KPGc+DQoJPHBhdGggc3R5bGU9ImZpbGw6IzQ1NUE2NDsiIGQ9Ik01My4zMzMsNjRIMTAuNjY3QzQuNzc2LDY0LDAsNTkuMjI0LDAsNTMuMzMzVjEwLjY2N0MwLDQuNzc2LDQuNzc2LDAsMTAuNjY3LDBoNDIuNjY3DQoJCUM1OS4yMjQsMCw2NCw0Ljc3Niw2NCwxMC42Njd2NDIuNjY3QzY0LDU5LjIyNCw1OS4yMjQsNjQsNTMuMzMzLDY0eiIvPg0KCTxwYXRoIHN0eWxlPSJmaWxsOiM0NTVBNjQ7IiBkPSJNNTAxLjMzMyw2NGgtNDIuNjY3QzQ1Mi43NzYsNjQsNDQ4LDU5LjIyNCw0NDgsNTMuMzMzVjEwLjY2N0M0NDgsNC43NzYsNDUyLjc3NiwwLDQ1OC42NjcsMGg0Mi42NjcNCgkJQzUwNy4yMjQsMCw1MTIsNC43NzYsNTEyLDEwLjY2N3Y0Mi42NjdDNTEyLDU5LjIyNCw1MDcuMjI0LDY0LDUwMS4zMzMsNjR6Ii8+DQoJPHBhdGggc3R5bGU9ImZpbGw6IzQ1NUE2NDsiIGQ9Ik01My4zMzMsNTEySDEwLjY2N0M0Ljc3Niw1MTIsMCw1MDcuMjI0LDAsNTAxLjMzM3YtNDIuNjY3QzAsNDUyLjc3Niw0Ljc3Niw0NDgsMTAuNjY3LDQ0OGg0Mi42NjcNCgkJQzU5LjIyNCw0NDgsNjQsNDUyLjc3Niw2NCw0NTguNjY3djQyLjY2N0M2NCw1MDcuMjI0LDU5LjIyNCw1MTIsNTMuMzMzLDUxMnoiLz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojNDU1QTY0OyIgZD0iTTUwMS4zMzMsNTEyaC00Mi42NjdjLTUuODkxLDAtMTAuNjY3LTQuNzc2LTEwLjY2Ny0xMC42Njd2LTQyLjY2Nw0KCQljMC01Ljg5MSw0Ljc3Ni0xMC42NjcsMTAuNjY3LTEwLjY2N2g0Mi42NjdjNS44OTEsMCwxMC42NjcsNC43NzYsMTAuNjY3LDEwLjY2N3Y0Mi42NjdDNTEyLDUwNy4yMjQsNTA3LjIyNCw1MTIsNTAxLjMzMyw1MTJ6Ii8+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8L3N2Zz4NCg==" />
          </button>
        </div>
      </div>
      <div class="pb-3" id="lineSelect" style="display: block;">
        <h5 class="card-title">線類型</h5>
        <select id="lineStyle" class="form-control">
          <option value="0">實線</option>
          <option value="1">虛線</option>
          <option value="2">橫線</option>
          <option value="3">圓點</option>
          <option value="4">雙虛</option>
          <option value="5">一實一虛</option>
        </select>
      </div>
      <div class="pb-3" id="faceSelect" style="display: none;">
        <h5 class="card-title">面類型</h5>
        <select id="faceStyle" class="form-control">
          <option value="0">一般</option>
          <option value="1">邊框</option>
          <option value="2">無邊框</option>
          <option value="3">填滿顏色</option>
          <option value="4">斜線</option>
          <option value="5">網格</option>
          <option value="6">面上有圖示</option>
        </select>
      </div>
      <div class="pb-3">
        <button class="btn btn-primary" onclick="Undo()">回到上一步</button>
      </div>
    </div>
  </div>
  <!-- Popup -->
  <div id="popup">
    <div class="menu">
      <ul class="list-group">
        <li class="list-group-item" onclick="StartToDraw()">繪圖</li>
        <li class="list-group-item" onclick="CancelToDraw()">取消繪圖</li>
      </ul>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.4.1/math.min.js"></script>
  <script src="./lineStyle.js"></script>
  <script src="./faceStyle.js"></script>
  <script>
    /**
     * 是否正在繪圖
     */
    var IsDrawing = false;
    /**
     * 已選取 Feature*/
    var selectedFeature = null;
    /**
     * 已選取圖層*/
    var selectedLayer = null;

    /**
     * 在地圖上選取物件/圖層
     */
    var selectClick = new ol.interaction.Select();

    /**
     * 修改 Feature (線段或面狀編輯回復上一步功能)
     */
    var previousCoordinatesOfSelected = {};
    /**
     * 被選取物件
     */
    var selectSource = new ol.Collection;
    /**
     * 被選取線段物件
     */
    lineStrokeSource.onchange = function () {
      selectSource = lineStrokeSource.getFeaturesCollection()
    }

    /**
     * 被選取物件框線加粗造型
     */
    var hoverStyle = new ol.style.Style({
      stroke: new ol.style.Stroke({
        color: 'red',
        width: 3,
      }),
      fill: new ol.style.Fill({
        color: 'black',
      }),
    });
    /**
     * 與地圖互動功能 
     * the type of interaction with map
     */
    var draw = new ol.interaction.Draw({
        source: lineStrokeSource,
        type: featureOfDrawing,
      }),
      snap = new ol.interaction.Snap({
        source: lineStrokeSource
      }),
      modify = new ol.interaction.Modify({
        features: selectSource
      });

    /**
     * 繪圖幾何類型 
     * the type of geometry of drawing
     */
    var typeOfGeometry = {
      point: 'Point',
      line: 'LineString',
      face: 'Polygon'
    }

    /**
     * 預設繪圖類型 
     * the default type of geometry of drawing
     */
    var featureOfDrawing = typeOfGeometry.line;

    /**
     * 面狀內圖示​ 
     * the image with face
     */
    var faceImageLayer, faceImageSource, faceImageUrl = 'https://img.icons8.com/plasticine/2x/user-location.png';

    /**
     * 右鍵選單初始化
     * initializing the context menu
     */
    var popup = new ol.Overlay({
      element: document.getElementById('popup'),
    });

    /**
     * 地圖圖層
     * the layer of map
     */
    var tile = new ol.layer.Tile({
      source: new ol.source.OSM()
    });

    /**
     * 地圖初始位置
     * the original position of map
     */
    var view = new ol.View({
      center: ol.proj.fromLonLat([37.41, 8.82]),
      zoom: 4
    });

    /**
     * 地圖初始化
     * Initializing the map
     */
    var map = new ol.Map({
      target: 'map',
      layers: [
        tile,
        lineStrokeVectorLayer,
        faceVectorLayer
      ],
      view: view
    });

    /**
     * 右鍵選單加入地圖
     * Add the popup on the map
     */
    map.addOverlay(popup);

    /**
     * 地圖加上選取 Feature 功能
     */
    map.addInteraction(selectClick);

    /**
     * 地圖加上允許編輯 Feature 功能
     */
    map.addInteraction(modify);

    /**
     * 點擊滑鼠右鍵開啟選單
     * Hide the default menu and show the context menu
     */
    map.getViewport().addEventListener('contextmenu', function (e) {
      e.preventDefault();
      let coordinate = map.getEventCoordinate(e);
      OpenContextMenu(coordinate);
    });

    /**
     * 點擊滑鼠左鍵關閉選單
     * Close the context menu
     */
    map.on('click', function () {
      popup.setPosition(undefined);
    })

    /**
     * 當點選 Feature/圖層
     */
    selectClick.on('select', function (e) {
      selectedFeature = e.selected.find((value, index) => index == 0);
      if (e.selected != null) {
        e.selected.forEach(function (feature) {
          selectSource.push(feature);
        });
      }

      if (e.deselected != null) {
        e.deselected.forEach(function (feature) {
          selectSource.remove(feature);
        });
      }
      if (!IsDrawing && selectedFeature != null) {
        /**
         * 地圖加上允許編輯 Feature 功能
         */
        map.addInteraction(modify);
        selectedFeature.setStyle(hoverStyle);
        selectedLayer = selectClick.getLayer(selectedFeature);
      }
    })

    /**
     * 線段或面狀編輯回復上一步功能
     * 紀錄最後編輯狀態
     */
    modify.on('modifystart', function (evt) {
      evt.features.forEach(function (feature) {
        previousCoordinatesOfSelected[feature] = feature.getGeometry().getCoordinates();
      });
    });

    /**
     * 變更繪圖類型
     * Change the type of geomery of drawing
     */
    function ChangeFeatureOfDrawing(feature) {
      featureOfDrawing = feature;
      SwiftThePanel();
      RemoveInteractions();
      AddInteractions();
    }

    /**
     * 切換編輯選單資訊
     * Change the editing panel
     */
    function SwiftThePanel() {
      let lineSelection = document.getElementById('lineSelect');
      let faceSelection = document.getElementById('faceSelect');
      let displayStatus = {
        show: 'block',
        close: 'none'
      }
      switch (featureOfDrawing) {
        case typeOfGeometry.line:
          lineSelection.style.display = displayStatus.show;
          faceSelection.style.display = displayStatus.close;
          break;
        case typeOfGeometry.face:
          lineSelection.style.display = displayStatus.close;
          faceSelection.style.display = displayStatus.show;
          break;
        default:
          lineSelection.style.display = displayStatus.show;
          faceSelection.style.display = displayStatus.close;
          break;
      }
    }
    /**
     * 開始與地圖互動
     * Start to interacte with map
     */
    function AddInteractions() {
      IsDrawing = true;
      switch (featureOfDrawing) {
        case typeOfGeometry.line:
          draw = new ol.interaction.Draw({
            source: lineStrokeSource,
            type: featureOfDrawing,
          });
          snap = new ol.interaction.Snap({
            source: lineStrokeSource
          });
          break;
        case typeOfGeometry.face:
          draw = new ol.interaction.Draw({
            source: faceSource,
            type: featureOfDrawing,
          });
          snap = new ol.interaction.Snap({
            source: lineStrokeSource
          });
          break;
        default:
          draw = new ol.interaction.Draw({
            source: lineStrokeSource,
            type: featureOfDrawing,
          });
          snap = new ol.interaction.Snap({
            source: lineStrokeSource
          });
          break;
      }
      /**
       * 地圖加上允許繪圖 Feature 功能
       */
      map.addInteraction(draw);

      //#region 面上顯示圖示 add a image on the face
      draw.on('drawend', (evt) => {
        if (featureOfDrawing === typeOfGeometry.face && parseInt(faceStyle.value) == 6) {
          let extent = evt.feature.getGeometry().getExtent();
          let center = ol.extent.getCenter(extent);

          faceImageSource = new ol.source.ImageStatic({
            url: faceImageUrl,
            imageExtent: [center[0] - 150, center[1] - 150, center[0] + 150, center[1] + 150],
          })
          faceImageLayer = new ol.layer.Image({
            extent: extent,
            source: faceImageSource
          })
          map.addLayer(faceImageLayer);
        }
      })
      //#endregion
    }

    /**
     * 開啟右鍵選單
     * show the context menu on the map
     */
    function OpenContextMenu(coordinate) {
      var element = popup.getElement();

      $(element).popover('dispose');
      popup.setPosition(coordinate);
      $(element).popover({
        container: element,
        placement: 'right',
        animation: false,
        html: true
      });
      $(element).popover('show');
    }

    /**
     * 開始繪圖
     */
    function StartToDraw() {
      IsDrawing = true;
      AddInteractions();
      popup.setPosition(undefined);
    }

    /**
     * 停止繪圖
     */
    function CancelToDraw() {
      IsDrawing = false;
      RemoveInteractions();
      popup.setPosition(undefined);
    }

    /**
     * 停止與地圖互動
     */
    function RemoveInteractions() {
      map.removeInteraction(draw);
      map.removeInteraction(modify);
    }

    /**
     * 線段或面狀編輯回復上一步功能
     */
    function Undo() {
      IsDrawing = false;
      if (selectedFeature in previousCoordinatesOfSelected) {
        // console.log('previousCoordinatesOfSelected[feature]', previousCoordinatesOfSelected[selectedFeature]);
        selectedFeature.getGeometry().setCoordinates(
          previousCoordinatesOfSelected[selectedFeature]
        );

        RemoveSelectedFeature(selectedSource);
        selectSource.push(selectedFeature);
      }
      popup.setPosition(undefined);
    }
  </script>
</body>

</html>