<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css"
    type="text/css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="./openlayers.css">
  <title>OpenLayers Exercises</title>
</head>

<body>
  <div id="map" class="map"></div>
  <div class="card">
    <div class="card-header">
      編輯
    </div>
    <div class="card-body">
      <div class="pb-3">
        <h5 class="card-title">線類型</h5>
        <select id="lineStyle" class="form-control">
          <option value="0">實線</option>
          <option value="1">虛線</option>
          <option value="2">橫線</option>
          <option value="3">圓點</option>
          <option value="4">雙虛</option>
          <option value="5">一實一虛</option>
        </select>
      </div>
      <div class="pb-3" id="faceSelect">
        <h5 class="card-title">面類型</h5>
        <select id="faceStyle" class="form-control">
          <option value="0">一般</option>
          <option value="1">邊框</option>
          <option value="2">無邊框</option>
          <option value="3">填滿顏色</option>
          <option value="4">斜線</option>
          <option value="5">網格</option>
          <option value="6">面上有圖示</option>
          <option value="7">面上有文字</option>
        </select>
      </div>
    </div>
  </div>
  <!-- Popup -->
  <div id="popup">
    <div class="menu">
      <ul class="list-group">
        <li class="list-group-item" onclick="StartToDraw()">繪圖</li>
        <li class="list-group-item" onclick="CancelToDraw()">取消繪圖</li>
      </ul>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.4.1/math.min.js"></script>
  <script src="./lineStyle.js"></script>
  <script>
    // Popup showing the position the user clicked
    var popup = new ol.Overlay({
      element: document.getElementById('popup'),
    });

    var tile = new ol.layer.Tile({
      source: new ol.source.OSM()
    });

    var view = new ol.View({
      center: ol.proj.fromLonLat([37.41, 8.82]),
      zoom: 4
    });

    //Initial the map
    var map = new ol.Map({
      target: 'map',
      layers: [
        tile,
        lineStrokeVectorLayer
      ],
      view: view
    });

    //Add the popup on the map
    map.addOverlay(popup);

    //Hide the default menu and show the context menu
    map.getViewport().addEventListener('contextmenu', function (e) {
      e.preventDefault();
      let coordinate = map.getEventCoordinate(e);
      openContextMenu(coordinate);
    });

    //Close the context menu
    map.on('click', function () {
      popup.setPosition(undefined);
    })

    var draw, snap;
    function addInteractions() {
      draw = new ol.interaction.Draw({
        source: lineStrokeSource,
        type: 'LineString',
      });
      snap = new ol.interaction.Snap({
        source: lineStrokeSource
      });
      map.addInteraction(draw);
      map.addInteraction(snap);
    }

    function openContextMenu(coordinate) {
      var element = popup.getElement();
      //var hdms = toStringHDMS(toLonLat(coordinate));

      $(element).popover('dispose');
      popup.setPosition(coordinate);
      $(element).popover({
        container: element,
        placement: 'right',
        animation: false,
        html: true,
        //content: '<p>The location you clicked was:</p><code>' + hdms + '</code>',
      });
      $(element).popover('show');
    }

    function StartToDraw() {
      addInteractions();
      popup.setPosition(undefined);
    }

    function CancelToDraw() {
      map.removeInteraction(draw);
      popup.setPosition(undefined);
    }
  </script>
</body>

</html>